{% extends 'main/base.html' %}

{% block title %}Leave Requests - HR{% endblock %}

{% block content %}
    {% if messages %}
        <div class="alert alert-info">
            {% for message in messages %}
                <p>{{ message }}</p>
            {% endfor %}
        </div>
    {% endif %}
    
    <div class="container">
        <h2 class="text-center mb-4">Leave Requests Sent to HR</h2>

        {% if leave_requests %}
            <ul class="list-group">
                {% for leave in leave_requests %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        {{ leave.employee.get_full_name }} - {{ leave.leave_type }} from {{ leave.start_date }} to {{ leave.end_date }}
                        <a href="{% url 'hr_leave_management:approve_reject_leave' leave.id %}" class="btn btn-info btn-sm">View</a>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>No leave requests sent to HR yet.</p>
        {% endif %}

        <h3>Last Approved Leave</h3>
        {% if last_approved_leave %}
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Employee Name</th>
                        <th>Leave Type</th>
                        <th>Start Date</th>
                        <th>End Date</th>
                        <th>Status</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>{{ last_approved_leave.employee.get_full_name }}</td>
                        <td>{{ last_approved_leave.leave_type }}</td>
                        <td>{{ last_approved_leave.start_date }}</td>
                        <td>{{ last_approved_leave.end_date }}</td>
                        <td class="text-success">Approved</td>
                        <td>
                            <button class="btn btn-info btn-sm" data-toggle="collapse" data-target="#approved-details-{{ last_approved_leave.id }}">
                                View Details
                            </button>
                            <div id="approved-details-{{ last_approved_leave.id }}" class="collapse">
                                <br>
                                <p><strong>Employee Reason:</strong> {{ last_approved_leave.reason }}</p>
                                <p><strong>HR Approval Reason:</strong> 
                                    {% if last_approved_leave.hr_reason %}
                                        {{ last_approved_leave.hr_reason }}
                                    {% else %}
                                        No reason provided
                                    {% endif %}
                                </p>
                                <p><strong>Manager Approval Reason:</strong> 
                                    {% if last_approved_leave.manager_reason %}
                                        {{ last_approved_leave.manager_reason }}
                                    {% else %}
                                        No reason provided
                                    {% endif %}
                                </p>
                                <p><strong>Comments:</strong> 
                                    {% if last_approved_leave.comments %}
                                        {{ last_approved_leave.comments }}
                                    {% else %}
                                        No comments provided
                                    {% endif %}
                                </p>

                                {% if last_approved_leave.document %}
                                    <p><strong>Attachment:</strong> 
                                        <a href="{{ last_approved_leave.document.url }}" target="_blank">Download File</a>
                                    </p>
                                {% else %}
                                    <p>No file attached.</p>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        {% else %}
            <p>No approved leave requests yet.</p>
        {% endif %}

        <h3>Last Rejected Leave</h3>
        {% if rejected_leaves %}
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Employee Name</th>
                        <th>Leave Type</th>
                        <th>Start Date</th>
                        <th>End Date</th>
                        <th>Status</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody>
                    {% for leave in rejected_leaves %}
                        <tr>
                            <td>{{ leave.employee.get_full_name }}</td>
                            <td>{{ leave.leave_type }}</td>
                            <td>{{ leave.start_date }}</td>
                            <td>{{ leave.end_date }}</td>
                            <td class="text-danger">Rejected</td>
                            <td>
                                <button class="btn btn-info btn-sm" data-toggle="collapse" data-target="#details-{{ leave.id }}">
                                    View Details
                                </button>
                                <div id="details-{{ leave.id }}" class="collapse">
                                    <br>
                                    <p><strong>Employee Reason:</strong> {{ leave.reason }}</p>
                                    <p><strong>Manager Reason:</strong> {% if leave.manager_reason %}{{ leave.manager_reason }}{% else %}No manager reason provided{% endif %}</p>
                                    <p>Comments: {% if leave.comments %}{{ leave.comments }}{% else %}No comments provided{% endif %}</p>

                                    {% if leave.document %}
                                        <p><strong>Attachment:</strong> 
                                            <a href="{{ leave.document.url }}" target="_blank">Download File</a>
                                        </p>
                                    {% else %}
                                        <p>No file attached.</p>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>No rejected leave requests yet.</p>
        {% endif %}
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

{% endblock %}
